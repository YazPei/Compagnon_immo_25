name: permissions

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read   # suffisant pour checkout; pas de création de secrets ici

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Secrets PRÉEXISTANTS dans le repo (Settings > Secrets and variables > Actions)
      COMPAGNON_SECRET_KETSIA: ${{ secrets.COMPAGNON_SECRET_KETSIA }}
      COMPAGNON_SECRET_YAZ:    ${{ secrets.COMPAGNON_SECRET_YAZ }}
      DAGSHUB_USER:            ${{ secrets.DAGSHUB_USERNAME }}      # ou DAGSHUB_USER
      DAGSHUB_TOKEN:           ${{ secrets.DAGSHUB_TOKEN }}
      DAGSHUB_REPO:            ${{ secrets.DAGSHUB_REPO_NAME }}      # ou DAGSHUB_REPO
      MLFLOW_TRACKING_URI:     ${{ secrets.MLFLOW_TRACKING_URI }}
      MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Générer config DagsHub/MLflow
        run: make setup_dags

      - name: Sanity check MLflow (ping API)
        run: |
          curl -i -u "$MLFLOW_TRACKING_USERNAME:$MLFLOW_TRACKING_PASSWORD" \
            "$MLFLOW_TRACKING_URI/api/2.0/mlflow/experiments/list" | head -n 20

      - name: Afficher config (sans secrets)
        run: |
          echo "Owner/Repo/URI:"
          cat infra/config/dagshub.yaml

