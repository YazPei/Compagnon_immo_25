name: permissions

on:
  workflow_dispatch:        # déclenchable à la demande
  push:
  pull_request:

permissions:
  contents: read            
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COMPAGNON_SECRET_KETSIA: ${{ secrets.COMPAGNON_SECRET_KETSIA }}
      COMPAGNON_SECRET_YAZ:    ${{ secrets.COMPAGNON_SECRET_YAZ }}
      DAGSHUB_USER:            ${{ secrets.DAGSHUB_USERNAME }}      # ou DAGSHUB_USER
      DAGSHUB_TOKEN:           ${{ secrets.DAGSHUB_TOKEN }}
      DAGSHUB_REPO:            ${{ secrets.DAGSHUB_REPO_NAME }}      # ou DAGSHUB_REPO
      MLFLOW_TRACKING_URI:     ${{ secrets.MLFLOW_TRACKING_URI }}
      MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Générer config DagsHub/MLflow
        run: make setup_dagshub

      - name: Sanity check MLflow (ping API)
        run: |
          curl -i -u "$MLFLOW_TRACKING_USERNAME:$MLFLOW_TRACKING_PASSWORD" \
            "$MLFLOW_TRACKING_URI/api/2.0/mlflow/experiments/list" | head -n 20

      - name: Afficher config (sans secrets)
        run: cat infra/config/dagshub.yaml
      
      - name: Générer .env depuis les secrets
        shell: bash
        run: |
          set -eu
          {
            echo "AIRFLOW__CORE__FERNET_KEY=${{ secrets.AIRFLOW__CORE__FERNET_KEY }}"
            echo "AIRFLOW__CORE__EXECUTOR=LocalExecutor"
            echo "AIRFLOW__CORE__DEFAULT_TIMEZONE=Europe/Paris"
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}"
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}"
            echo "MLFLOW_BACKEND_STORE_URI=${{ secrets.MLFLOW_BACKEND_STORE_URI }}"
            echo "MLFLOW_ARTIFACT_URI=${{ secrets.MLFLOW_ARTIFACT_URI }}"
            echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}"
            echo "DAGSHUB_USER=${{ secrets.DAGSHUB_USERNAME }}"
            echo "DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }}"
            echo "DAGSHUB_REPO_OWNER=${{ secrets.DAGSHUB_REPO_OWNER }}"
            echo "DAGSHUB_REPO_NAME=${{ secrets.DAGSHUB_REPO_NAME }}"
            echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}"
            echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.MLFLOW_TRACKING_PASSWORD }}"
          } > .env

      - name: Upload .env (artefact temporaire)
        uses: actions/upload-artifact@v4
        with:
          name: env-artifact
          path: .env
          retention-days: 1
          
      - name: Upload .env (artefact temporaire)
        uses: actions/upload-artifact@v4
        with:
        name: env-artifact
        path: .env
        retention-days: 1

     - name: Sanity .env
       run: |
         set -eu
         test -s .env || (echo "ERROR: .env vide ou manquant" && exit 1)
         wc -c .env

